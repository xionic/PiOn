(this.webpackJsonpPiOn=this.webpackJsonpPiOn||[]).push([[0],{59:function(e,t,n){},64:function(e,t,n){},66:function(e,t,n){},67:function(e,t,n){"use strict";n.r(t);var s=n(4),i=n(0),o=n.n(i),a=n(11),r=n.n(a),c=(n(59),n(31)),u=n(8),l=n(9),h=n(13),d=n(16),p=n(15),b=function(){function e(t,n,s,i,o){Object(u.a)(this,e),this.data=t,this.has_error=n,this.error_message=s,this.timestamp=i,this.certainty=o,this.initialised=!0}return Object(l.a)(e,null,[{key:"fromData",value:function(t){return new e(t,!1,"",Math.floor(Date.now()/1e3),e.CERTAIN)}},{key:"getUninitialised",value:function(){var t=new e(null,null,null,null,null);return t.initialised=!1,t}},{key:"checkValid",value:function(e){return e.hasOwnProperty("data")&&e.hasOwnProperty("has_error")&&e.hasOwnProperty("error_message")&&e.hasOwnProperty("timestamp")&&e.hasOwnProperty("certainty")&&e.hasOwnProperty("initialised")}},{key:"CERTAIN",get:function(){return"CERTAIN"}},{key:"UNCERTAIN",get:function(){return"UNCERTAIN"}},{key:"UNKNOWN",get:function(){return"UNKNOWN"}}]),e}(),m=function(){function e(t,n,s,i,o,a){Object(u.a)(this,e),this.type=t,this.context=n,this.sending_node=s,this.target_node=i,this.target_port=o,this.payload=a,this.id=this.REST_MESSAGE_COUNTER++}return Object(l.a)(e,[{key:"to_json",value:function(){return JSON.stringify({type:this.type,context:this.context,sending_node:this.sending_node,target_node:this.target_node,target_port:this.target_port,payload:this.payload,id:this.id})}}],[{key:"from_obj",value:function(t){return new e(t.type,t.context,t.sending_node,t.target_node,t.target_port,t.payload)}},{key:"from_json",value:function(t){var n=JSON.parse(t);return e.from_obj(n)}},{key:"withSendDefaults",value:function(t,n,s){return new e(t,n,"client",window.config.host,window.config.port,s)}},{key:"REQ",get:function(){return"REQ"}},{key:"RESP",get:function(){return"RESP"}},{key:"REST_CONTEXT_EVENT",get:function(){return"REST_CONTEXT_EVENT"}},{key:"REST_CONTEXT_ITEM",get:function(){return"REST_CONTEXT_ITEM"}},{key:"REST_CONTEXT_ITEMS",get:function(){return"REST_CONTEXT_ITEMS"}},{key:"REST_CONTEXT_SUBSCRIBE",get:function(){return"REST_CONTEXT_SUBSCRIBE"}},{key:"REST_CONTEXT_ERROR",get:function(){return"REST_CONTEXT_ERROR"}}]),e}(),f=function(){function e(t,n,s){Object(u.a)(this,e),"undefined"==typeof t&&console.error("Item name must be supplied"),"undefined"==typeof n&&console.error("Action must be supplied"),"undefined"==typeof s&&console.error("Value must be supplied"),this.item_name=t,this.value=s,this.action=n}return Object(l.a)(e,[{key:"to_json",value:function(){return JSON.stringify({item_name:this.item_name,value:this.value,action:this.action})}}],[{key:"from_json",value:function(e){var t=JSON.parse();return this.from_obj(t)}},{key:"from_obj",value:function(t){var n=t.value;return new e(t.item_name,t.action,new b(n.data,n.has_error,n.error_message,n.timestamp,n.certainty))}},{key:"GET",get:function(){return"GET"}},{key:"SET",get:function(){return"SET"}}]),e}(),v=function(){function e(t,n,s){Object(u.a)(this,e),"undefined"==typeof t&&console.error("Item name must be supplied"),this.subscriptions=t,this.type=n,this.get_now=s}return Object(l.a)(e,[{key:"to_json",value:function(){return JSON.stringify({subscriptions:this.subscriptions,type:this.type,get_now:this.get_now})}}],[{key:"SUBSCRIBE",get:function(){return"SUBSCRIBE"}},{key:"REFRESH_ALL",get:function(){return"REFRESH_ALL"}},{key:"REQUEST_VALUES",get:function(){return"REQUEST_VALUES"}}]),e}(),g=function(){function e(){Object(u.a)(this,e)}return Object(l.a)(e,null,[{key:"events",get:function(){return{ITEM_VALUE_CHANGED:"ITEM_VALUE_CHANGED"}}}]),e}();g.ITEM_VALUE_CHANGED="ITEM_VALUE_CHANGED";var j=n(46);function _(e){var t=Object(i.useState)(""),n=Object(j.a)(t,2),o=n[0],a=n[1];return Object(i.useEffect)((function(){if(null!==e.websocket){var t=setInterval((function(){var t="";switch(e.websocket.readyState){case 0:t="connecting";break;case 1:t="connected";break;case 2:t="closing";break;case 3:t="closed";break;default:throw Error("Unknown websocket status: {props.websocket.readyState}")}var n=new Date,s=""+n.getHours(),i=""+n.getMinutes(),o=""+n.getSeconds();a("Websocket is "+t+"@"+s.padStart(2,"0")+":"+i.padStart(2,"0")+":"+o.padStart(2,"0"))}),500);return function(){clearInterval(t)}}a("Websocket is initialising")})),Object(s.jsx)("div",{id:"websocketstatus",children:o})}var w=n(103),O=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).state={anchorEl:null},s.handleShowValuePopup=s.handleShowValuePopup.bind(Object(h.a)(s)),s.handleHideValuePopup=s.handleHideValuePopup.bind(Object(h.a)(s)),s}return Object(l.a)(n,[{key:"handleShowValuePopup",value:function(e){console.log("show popup!"),this.setState({anchorEl:e.currentTarget})}},{key:"handleHideValuePopup",value:function(e){console.log("hide popup!"),this.setState({anchorEl:null})}},{key:"render",value:function(){var e;if(void 0!==this.props.value.timestamp){var t=new Date(1e3*this.props.value.timestamp),n=""+t.getFullYear(),i=(""+(t.getMonth()+1)).padStart(2,"0"),o=(""+t.getDate()).padStart(2,"0");e=(""+t.getHours()).padStart(2,"0")+":"+(""+t.getMinutes()).padStart(2,"0")+":"+(""+t.getSeconds()).padStart(2,"0")+" "+n+"/"+i+"/"+o}var a=Object(s.jsxs)(w.a,{anchorEl:this.state.anchorEl,onClose:this.handleHideValuePopup,open:null!==this.state.anchorEl,anchorOrigin:{vertical:"bottom",horizontal:"center"},children:[Object(s.jsxs)("div",{children:["data: ",this.props.value.data]}),Object(s.jsxs)("div",{children:["has_error: ",this.props.value.has_error?"true":"false"]}),Object(s.jsxs)("div",{children:["error_msg: ",this.props.value.error_msg]}),Object(s.jsxs)("div",{children:["timestamp: ",e]}),Object(s.jsxs)("div",{children:["certainty: ",this.props.value.certainty]}),Object(s.jsxs)("div",{children:["initialised: ",this.props.value.initialised?"true":"false"]})]}),r=this.props.type;return Object(s.jsxs)("span",{children:[Object(s.jsx)("span",{className:"itemname",onClick:this.handleShowValuePopup,children:this.props.item_name}),a,Object(s.jsx)("span",{className:"itemvalue",children:Object(s.jsx)(r,{item_name:this.props.item_name,value:this.props.value,onValueChange:this.props.onValueChange,all_values:this.props.all_values,subscribeItem:this.props.subscribeItem})})]})}}]),n}(i.Component),E=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;if(Object(u.a)(this,n),s=t.call(this,e),!e.hasOwnProperty("value")||!b.checkValid(e.value))throw Error("No or invalid value given to module");return s}return Object(l.a)(n,[{key:"render",value:function(){return this.props.value.initialised?this.pionRender():Object(s.jsx)("span",{children:"No Value yet"})}}]),n}(i.Component),k=n(104),S=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).handleChange=s.handleChange.bind(Object(h.a)(s)),s}return Object(l.a)(n,[{key:"handleChange",value:function(e){var t=b.fromData(e.target.checked?1:0);this.props.onValueChange(this.props.item_name,t)}},{key:"pionRender",value:function(){var e=1===this.props.value.data;return Object(s.jsx)("span",{children:Object(s.jsx)(k.a,{disabled:!!this.props.hasOwnProperty("disabled")&&this.props.disabled,onChange:this.handleChange,checked:e,className:"react-switch"})})}}]),n}(E),y=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).text_prefix="",s.text_postfix="",s}return Object(l.a)(n,[{key:"pionRender",value:function(){return this.updatePrefix(),this.updatePostfix(),Object(s.jsxs)("span",{children:[this.text_prefix,this.props.value.data,this.text_postfix]})}},{key:"updatePrefix",value:function(){}},{key:"updatePostfix",value:function(){}}]),n}(E),T=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(){return Object(u.a)(this,n),t.apply(this,arguments)}return Object(l.a)(n,[{key:"updatePostfix",value:function(){var e=new Date(1e3*this.props.value.timestamp),t=e.getTime(),n=(new Date).getTime(),s=Math.floor((n-t)/864e5),i="";s>0&&(i=" -"+s+" days");var o=("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2);this.text_postfix="\xb0@"+o+i}}]),n}(y),C=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(){return Object(u.a)(this,n),t.apply(this,arguments)}return Object(l.a)(n,[{key:"updatePostfix",value:function(){var e=new Date(1e3*this.props.value.timestamp),t=e.getTime(),n=(new Date).getTime(),s=Math.floor((n-t)/864e5),i="";s>0&&(i=" -"+s+" days");var o=("0"+e.getHours()).slice(-2)+":"+("0"+e.getMinutes()).slice(-2)+":"+("0"+e.getSeconds()).slice(-2);this.text_postfix="%@"+o+i}}]),n}(y),R=n(102),P=n(101),x=(n(64),function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).handleChange=s.handleChange.bind(Object(h.a)(s)),s.handlePlus=s.handlePlus.bind(Object(h.a)(s)),s.handleMinus=s.handleMinus.bind(Object(h.a)(s)),s.increment=.5,s}return Object(l.a)(n,[{key:"handleChange",value:function(e){console.log("CHANGE",e.target.value);var t=b.fromData(e.target.value);this.sendNewValue(t)}},{key:"handlePlus",value:function(e){var t=parseFloat(this.props.value.data)+this.increment,n=b.fromData(t);this.sendNewValue(n)}},{key:"handleMinus",value:function(e){var t=parseFloat(this.props.value.data)-this.increment,n=b.fromData(t);this.sendNewValue(n)}},{key:"sendNewValue",value:function(e){this.props.onValueChange(this.props.item_name,e)}},{key:"pionRender",value:function(){return Object(s.jsxs)("span",{children:[Object(s.jsx)(R.a,{onChange:this.handleChange,size:"small",type:"number",value:this.props.value.data,classes:{root:"pion-modulesetpointinput"},inputProps:{step:this.increment,size:2}}),Object(s.jsx)(P.a,{classes:{root:"pion-modulesetpointbutton"},onClick:this.handlePlus,children:"+"}),Object(s.jsx)(P.a,{classes:{root:"pion-modulesetpointbutton"},onClick:this.handleMinus,children:"-"})]})}}]),n}(E)),I=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).state={initComplete:!1},s.handleChange=s.handleChange.bind(Object(h.a)(s)),s.initStarted=!1,s}return Object(l.a)(n,[{key:"handleChange",value:function(e,t){this.props.onValueChange(e,t)}},{key:"pionRender",value:function(){if(!this.initStarted){this.initStarted=!0,this.setpoint=this.props.value.data.setpoint,this.heater_switch=this.props.value.data.heater_switch,this.state_switch=this.props.value.data.state_switch,this.temp_item=this.props.value.data.temp_item;var e=this.props.subscribeItem(this.setpoint),t=this.props.subscribeItem(this.heater_switch),n=this.props.subscribeItem(this.state_switch),i=this.props.subscribeItem(this.temp_item);Promise.all([e,t,n,i]).then(function(){if(!this.props.all_values.hasOwnProperty(this.setpoint))throw Error("Thermostat setpoint item has no value.Is it the correct item?");if(!this.props.all_values.hasOwnProperty(this.heater_switch))throw Error("Thermostat heater_switch item has no value.Is it the correct item?");if(!this.props.all_values.hasOwnProperty(this.state_switch))throw Error("Thermostat state_switch item has no value.Is it the correct item?");if(!this.props.all_values.hasOwnProperty(this.temp_item))throw Error("Thermostat temp_item item has no value.Is it the correct item?");this.setState({initComplete:!0})}.bind(this))}return this.state.initComplete?Object(s.jsxs)("span",{children:[Object(s.jsx)(S,{item_name:this.state_switch,value:this.props.all_values[this.state_switch],all_values:this.props.all_values,onValueChange:this.handleChange}),Object(s.jsx)(x,{item_name:this.setpoint,value:this.props.all_values[this.setpoint],all_values:this.props.all_values,onValueChange:this.handleChange}),Object(s.jsx)(T,{item_name:this.temp_item,value:this.props.all_values[this.temp_item],all_values:this.props.all_values}),Object(s.jsx)(S,{item_name:this.heater_switch,value:this.props.all_values[this.heater_switch],all_values:this.props.all_values,disabled:!0})]}):Object(s.jsx)("span",{children:"Initialising..."})}}]),n}(E);n(66);window.config=null;var N=function(e){Object(d.a)(n,e);var t=Object(p.a)(n);function n(e){var s;return Object(u.a)(this,n),(s=t.call(this,e)).state={moduleValues:{},errorMsg:{},sitemap:{}},s.handleModuleValueChange=s.handleModuleValueChange.bind(Object(h.a)(s)),s.sendValueUpdate=s.sendValueUpdate.bind(Object(h.a)(s)),s.connectWebsocket=s.connectWebsocket.bind(Object(h.a)(s)),s.subscribeItem=s.subscribeItem.bind(Object(h.a)(s)),s.modules={switch:S,text:y,temperature:T,humidity:C,thermostat:I,setpoint:x},s.websocket=null,s.modulesInited=!1,s.modulesInitedProm=new Promise(function(e){this.modulesInitedPromResolver=e}.bind(Object(h.a)(s))),s.mountedProm=new Promise((function(e){s.mountedPromResolver=e})),s.errorMsgCounter=0,s.websocketConnectedProm=new Promise((function(e){s.websocketConnectedPromResolver=e})),s.configLoadProm=new Promise((function(e){fetch("webconfig.json").then((function(e){return e.json()})).then((function(t){window.config=t,console.debug("config.json loaded",window.config),null===window.config.host&&(window.config.host=window.location.hostname),window.config.websocket_url="ws://"+window.config.host+":"+window.config.port+window.config.websocket_path,window.config.api_url="http://"+window.config.host+":"+window.config.port+"/api/",e()}))})),s.sitemapLoadProm=new Promise((function(e){fetch("sitemap.json").then((function(e){return e.json()})).then((function(t){var n=t;console.debug("sitemap.json loaded",n);var i={};for(var o in n)n[o].forEach((function(e){i[e.item_name]=b.getUninitialised()}));s.mountedProm.then(function(){var t=this;this.setState({moduleValues:i,sitemap:n},(function(){t.modulesInited=!0,t.modulesInitedPromResolver(!0),e()}))}.bind(Object(h.a)(s)))}))})),s}return Object(l.a)(n,[{key:"componentDidMount",value:function(){var e=this;this.mountedPromResolver(),this.configLoadProm.then((function(){e.sitemapLoadProm.then((function(){e.connectWebsocket()}))}))}},{key:"subscribeItem",value:function(e){return this.state.moduleValues.hasOwnProperty(e)?Promise.resolve(!0):new Promise(function(e,t){this.mountedProm.then(function(e,t){this.websocketConnectedProm.then(function(e,t){this.setState((function(t){var n=Object(c.a)({},t);return n.moduleValues[e]=b.getUninitialised(),n})),t(!0);var n={};n[e]=[g.ITEM_VALUE_CHANGED];var s=new v(n,v.SUBSCRIBE,v.REQUEST_VALUES),i=new m(m.REQ,m.REST_CONTEXT_SUBSCRIBE,"client",window.config.host,window.config.port,s);console.log("WS: Sending SUBSCRIBE RestMessage: ",i),this.websocket.send(i.to_json())}.bind(this,e,t))}.bind(this,e,t))}.bind(this,e))}},{key:"handleModuleValueChange",value:function(e,t){if(b.checkValid(t))throw Error("value passed is not an instance of Value");this.sendValueUpdate(e,t)}},{key:"sendValueUpdate",value:function(e,t){var n=new f(e,f.SET,t),s=m.withSendDefaults(m.REQ,m.REST_CONTEXT_ITEM,n);console.debug("Sending update to server for item '".concat(e,"' and item_message:"),n);var i=window.config.api_url+"?data="+encodeURIComponent(s.to_json());console.debug("Full URL: ".concat(i)),fetch(i).then((function(e){console.debug("SET request result:",e)}))}},{key:"reconnectWebsocket",value:function(){this.modulesInited=!1,this.modulesInitedProm=new Promise(function(e){this.modulesInitedPromResolver=e}.bind(this)),this.setState((function(e){var t=Object(c.a)({},e);for(var n in t.moduleValues)t.moduleValues[n]=b.getUninitialised()}),function(){this.modulesInited=!0,this.modulesInitedPromResolver(),this.websocket.close(),this.websocket=null,this.connectWebsocket()}.bind(this))}},{key:"removeErrorMsg",value:function(e){this.setState((function(t){var n=Object(c.a)({},t);return delete n.errorMsg[e],n}))}},{key:"connectWebsocket",value:function(){null===this.websocket?this.modulesInitedProm.then(function(){this.websocket_prom=new Promise(function(e){console.debug("Websocket connecting..."),this.websocket=new WebSocket(window.config.websocket_url),this.websocket.onopen=function(){var t=this;console.log("Websocket connection established to:",window.config.websocket_url),this.setState({webSocket:this.websocket},(function(){e(t.websocket),t.websocketConnectedPromResolver(t.websocket)}));var n={};for(var s in this.state.moduleValues)n[s]=[g.ITEM_VALUE_CHANGED];var i=new v(n,v.SUBSCRIBE,v.REQUEST_VALUES),o=new m(m.REQ,m.REST_CONTEXT_SUBSCRIBE,"client",window.config.host,window.config.port,i);console.log("WS: Sending SUBSCRIBE RestMessage: ",o),this.websocket.send(o.to_json())}.bind(this),this.websocket.onmessage=function(e){var t=m.from_json(e.data);switch(console.log("Message from WebSocket ",t),t.context){case m.REST_CONTEXT_ITEM:t.payload=[t.payload];case m.REST_CONTEXT_ITEMS:t.payload.forEach(function(e){var t=f.from_obj(e);console.debug("WS: Received value for item: ",t.item_name," with data: ",t.value.data),this.setState((function(e){var n=Object(c.a)({},e);return n.moduleValues[t.item_name]=t.value,n}))}.bind(this));break;case m.REST_CONTEXT_ERROR:console.log("WS: Received ERROR message: "+t.payload);var n=this.errorMsgCounter++;this.setState(function(e){var s=Object(c.a)({},e);return s.errorMsg[n]=t.payload,setTimeout(function(){this.removeErrorMsg(n)}.bind(this),5e3),s}.bind(this));break;default:console.log("WS: Received unknown rest message context: "+t.context)}}.bind(this),this.websocket.onerror=function(){console.debug("Websocket error")}.bind(this),this.websocket.onclose=function(){console.debug("Websocket closed - reconnecting"),setTimeout(function(){this.reconnectWebsocket()}.bind(this),1e3)}.bind(this)}.bind(this))}.bind(this)):console.error("Websocket already exists")}},{key:"render",value:function(){var e=this;if(null!==window.config&&null!==this.state.sitemap&&!1!==this.modulesInited){var t=[],n=function(n){var i=[];e.state.sitemap[n].forEach((function(t){var n=new URLSearchParams(document.location.search.substring(1));if(!t.auth||null!=n.get("auth")){var o=e.modules[t.type],a=e.state.moduleValues[t.item_name];i.push(Object(s.jsx)("li",{className:"item",children:Object(s.jsx)(O,{type:o,item_name:t.item_name,value:a,onValueChange:e.handleModuleValueChange,all_values:e.state.moduleValues,subscribeItem:e.subscribeItem})},t.item_name))}})),t.push(Object(s.jsxs)("li",{className:"roomrow",children:[Object(s.jsx)("h3",{className:"roomname",children:n}),Object(s.jsx)("ul",{children:i})]},n))};for(var i in this.state.sitemap)n(i);var o=[];if(""!==this.state.errorMsg)for(var a in this.state.errorMsg)o.push(Object(s.jsx)("div",{className:"rest_errorMsg",children:this.state.errorMsg[a]},a));return Object(s.jsxs)("div",{id:"outercont",children:[o,Object(s.jsx)("div",{children:Object(s.jsx)(_,{websocket:this.state.webSocket})}),Object(s.jsx)("div",{id:"tablecont",children:Object(s.jsx)("ul",{children:t})})]})}return Object(s.jsx)("span",{children:"Loading config and sitemap..."})}}]),n}(i.Component),V=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,105)).then((function(t){var n=t.getCLS,s=t.getFID,i=t.getFCP,o=t.getLCP,a=t.getTTFB;n(e),s(e),i(e),o(e),a(e)}))};r.a.render(Object(s.jsx)(o.a.StrictMode,{children:Object(s.jsx)(N,{})}),document.getElementById("root")),V()}},[[67,1,2]]]);
//# sourceMappingURL=main.0469aabf.chunk.js.map